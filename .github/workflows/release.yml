name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install and cache PowerShell modules
        uses: potatoqualitee/psmodulecache@v6.2.1
        with:
          modules-to-cache: Pester:5.7.1, PSScriptAnalyzer:1.22.0, PowerShellBuild:0.6.1, BuildHelpers:2.0.16, psake:4.9.0, dbatools:2.1.31, PSLogging:2.2.0, PsIni:3.1.2
          shell: pwsh

      - name: Run Tests
        shell: pwsh
        run: |
          ./build.ps1 -Task Test -Bootstrap

      - name: Build Module
        shell: pwsh
        run: |
          ./build.ps1

      - name: Create Module Archive
        shell: pwsh
        run: |
          $modulePath = Get-ChildItem -Path ./Output -Directory | Select-Object -First 1
          Compress-Archive -Path $modulePath.FullName -DestinationPath ./Output/BPC.DBRefresh.zip -Force

      - name: Create Release and Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "Release ${{ github.ref_name }}" \
            --notes "Release ${{ github.ref_name }}" \
            ./Output/BPC.DBRefresh.zip

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $modulePath = Get-ChildItem -Path ./Output -Directory | Select-Object -First 1
          Publish-Module -Path $modulePath.FullName -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose