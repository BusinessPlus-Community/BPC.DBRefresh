name: CI

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install and cache PowerShell modules
        uses: potatoqualitee/psmodulecache@v6.2.1
        with:
          modules-to-cache: Pester:5.7.1, PSScriptAnalyzer:1.22.0, PowerShellBuild:0.6.1, BuildHelpers:2.0.16, psake:4.9.0, dbatools:2.1.31, PSLogging:2.5.2, PsIni:3.1.2
          shell: pwsh

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Invoke-ScriptAnalyzer -Path . -Recurse -ReportSummary -Settings PSScriptAnalyzerSettings.psd1 -ExcludeRule PSAvoidUsingWriteHost

      - name: Run Tests with Coverage
        shell: pwsh
        run: |
          ./build.ps1 -Task Test -Bootstrap
          
      - name: Generate Coverage Report
        if: matrix.os == 'ubuntu-latest'
        shell: pwsh
        run: |
          # Set up BuildHelpers environment variables
          Import-Module BuildHelpers -Force
          Set-BuildEnvironment -Force
          
          # Build the module first to ensure output directory exists
          ./build.ps1 -Task Build -Bootstrap
          
          # Now run coverage on the built module
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.CodeCoverage.Enabled = $true
          $config.CodeCoverage.Path = './Output/BPC.DBRefresh/*/BPC.DBRefresh.psm1'
          $config.CodeCoverage.OutputFormat = 'CoverageGutters'
          $config.CodeCoverage.OutputPath = './coverage.xml'
          $config.CodeCoverage.CoveragePercentTarget = 80
          Invoke-Pester -Configuration $config

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: tests/out/testResults*.xml

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install and cache PowerShell modules
        uses: potatoqualitee/psmodulecache@v6.2.1
        with:
          modules-to-cache: Pester:5.7.1, PSScriptAnalyzer:1.22.0, PowerShellBuild:0.6.1, BuildHelpers:2.0.16, psake:4.9.0, dbatools:2.1.31, PSLogging:2.5.2, PsIni:3.1.2
          shell: pwsh

      - name: Build Module
        shell: pwsh
        run: |
          ./build.ps1 -Bootstrap

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BPC.DBRefresh
          path: Output/BPC.DBRefresh/